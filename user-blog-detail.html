<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
  <title>é»‘é©¬ç‚¹è¯„</title>
  <!-- å¼•å…¥æ ·å¼ -->
  <link rel="stylesheet" href="./css/element.css">

  <link href="./css/blog-detail.css" rel="stylesheet">
  <link href="./css/main.css" rel="stylesheet">
  <link href="./css/loading.css" rel="stylesheet">



</head>
<body>
<script>
  console.log("=== é¡µé¢bodyå¼€å§‹åŠ è½½ ===");
  console.log("å½“å‰URL:", window.location.href);
  console.log("å½“å‰æ—¶é—´:", new Date().toISOString());

  document.addEventListener('DOMContentLoaded', function() {
    console.log("=== DOMå†…å®¹å·²åŠ è½½å®Œæˆ ===");
    console.log("document.readyState:", document.readyState);
    console.log("#appå…ƒç´ æ˜¯å¦å­˜åœ¨:", !!document.getElementById('app'));
  });

  window.addEventListener('load', function() {
    console.log("=== é¡µé¢å®Œå…¨åŠ è½½å®Œæˆ ===");
  });

  window.addEventListener('error', function(e) {
    console.error("=== é¡µé¢é”™è¯¯ ===", e.error, e.message, e.filename, e.lineno);
  });
</script>
<div id="app">
  <div class="header">
    <div class="header-back-btn" @click="goBack"><i class="el-icon-arrow-left"></i></div>
    <div class="header-title"></div>
    <div class="header-share">...</div>
  </div>
  <div class="main-content">
    <!-- åšå®¢æ ‡é¢˜ -->
    <div v-if="pageLoading.blog" class="blog-title-loading-enhanced">
      <div style="height: 20px; background: #f0f0f0; border-radius: 4px; width: 70%;"></div>
    </div>
    <div v-else-if="blog && blog.title" class="blog-title-enhanced">
      <i class="el-icon-star-on"></i>
      {{blog.title}}
    </div>
    
    <!-- åšå®¢å›¾ç‰‡åŠ è½½çŠ¶æ€ -->
    <div v-if="pageLoading.blog" class="image-placeholder">
      <div style="text-align: center;">
        <i class="el-icon-loading" style="font-size: 24px; color: #409EFF;"></i>
        <div style="margin-top: 10px; color: #666;">åŠ è½½ä¸­...</div>
      </div>
    </div>

    <!-- åšå®¢å›¾ç‰‡è½®æ’­ -->
    <div v-if="!pageLoading.blog && blog.images && blog.images.length > 0" class="blog-info-box" ref="swiper"
         @touchstart="moveStart"
         @touchmove="moving"
         @touchend="moveEnd"
         style="display: flex; align-items: center; justify-content: center;">
      <div class="swiper-item" v-for="(img, i) in blog.images" :key="i">
        <img :src="img" alt="" class="blog-image-adaptive"
             @load="img.complete && updateContainerHeight($event.target)"
             @click="showImageModal(img)"
             :title="'ç‚¹å‡»æŸ¥çœ‹å¤§å›¾'">
      </div>
    </div>

    <!-- æ— å›¾ç‰‡çŠ¶æ€ -->
    <div v-else-if="!pageLoading.blog && (!blog.images || blog.images.length === 0)" class="image-placeholder">
      <i class="el-icon-picture" style="font-size: 48px; color: #999;"></i>
    </div>
    <!-- åšå®¢åŸºæœ¬ä¿¡æ¯ -->
    <div v-if="pageLoading.blog" class="basic" style="padding: 15px;">
      <div style="display: flex; align-items: center;">
        <div style="width: 40px; height: 40px; background: #f0f0f0; border-radius: 50%; margin-right: 10px;"></div>
        <div style="flex: 1;">
          <div style="height: 16px; background: #f0f0f0; border-radius: 4px; margin-bottom: 8px; width: 60%;"></div>
          <div style="height: 12px; background: #f0f0f0; border-radius: 4px; width: 40%;"></div>
        </div>
        <div style="width: 60px; height: 30px; background: #f0f0f0; border-radius: 4px;"></div>
      </div>
    </div>

    <div v-else class="basic">
      <div class="basic-icon" @click="toOtherInfo">
        <img :src="blog.icon || '/imgs/icons/default-icon.png'" alt="">
      </div>
      <div class="basic-info">
        <div class="name">{{blog.name || 'æœªçŸ¥ç”¨æˆ·'}}</div>
        <span class="time">{{blog.createTime ? formatTime(new Date(blog.createTime)) : ''}}</span>
      </div>
      <div style="width: 20%">
        <div class="logout-btn" @click="follow" v-show="!pageLoading.user && user && user.id !== blog.userId">
          {{followed ? 'å–æ¶ˆå…³æ³¨' : 'å…³æ³¨'}}
        </div>
      </div>
    </div>
    <!-- åšå®¢å†…å®¹ -->
    <div v-if="pageLoading.blog" style="padding: 15px;">
      <div style="height: 16px; background: #f0f0f0; border-radius: 4px; margin-bottom: 10px;"></div>
      <div style="height: 16px; background: #f0f0f0; border-radius: 4px; margin-bottom: 10px; width: 80%;"></div>
      <div style="height: 16px; background: #f0f0f0; border-radius: 4px; margin-bottom: 10px; width: 90%;"></div>
      <div style="height: 16px; background: #f0f0f0; border-radius: 4px; width: 70%;"></div>
    </div>

    <div v-else class="blog-text" v-html="blog.content || 'æš‚æ— å†…å®¹'">
    </div>
    <!-- å•†åº—ä¿¡æ¯ -->
    <div v-if="pageLoading.shop" class="shop-basic">
      <div style="width: 60px; height: 60px; background: #f0f0f0; border-radius: 8px; margin-right: 15px;"></div>
      <div style="width: 80%">
        <div style="height: 18px; background: #f0f0f0; border-radius: 4px; margin-bottom: 8px; width: 60%;"></div>
        <div style="height: 16px; background: #f0f0f0; border-radius: 4px; margin-bottom: 8px; width: 40%;"></div>
        <div style="height: 14px; background: #f0f0f0; border-radius: 4px; width: 50%;"></div>
      </div>
    </div>

    <div v-else-if="shop && shop.id" class="shop-basic">
      <div class="shop-icon">
        <img :src="shop.image || '/imgs/icons/default-shop.png'" alt="">
      </div>
      <div style="width: 80%">
        <div class="name">{{shop.name || 'æœªçŸ¥å•†åº—'}}</div>
        <div>
          <el-rate
              v-model="shopScore"
              disabled>
          </el-rate>
        </div>
          <div class="shop-avg">ï¿¥{{shop.avgPrice || 0}}/äºº</div>
      </div>
    </div>
    <!-- ç‚¹èµåŒºåŸŸ -->
    <div v-if="pageLoading.likes || pageLoading.blog" class="zan-box">
      <div>
        <svg t="1646634642977" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2187" width="20" height="20">
          <path d="M160 944c0 8.8-7.2 16-16 16h-32c-26.5 0-48-21.5-48-48V528c0-26.5 21.5-48 48-48h32c8.8 0 16 7.2 16 16v448zM96 416c-53 0-96 43-96 96v416c0 53 43 96 96 96h96c17.7 0 32-14.3 32-32V448c0-17.7-14.3-32-32-32H96zM505.6 64c16.2 0 26.4 8.7 31 13.9 4.6 5.2 12.1 16.3 10.3 32.4l-23.5 203.4c-4.9 42.2 8.6 84.6 36.8 116.4 28.3 31.7 68.9 49.9 111.4 49.9h271.2c6.6 0 10.8 3.3 13.2 6.1s5 7.5 4 14l-48 303.4c-6.9 43.6-29.1 83.4-62.7 112C815.8 944.2 773 960 728.9 960h-317c-33.1 0-59.9-26.8-59.9-59.9v-455c0-6.1 1.7-12 5-17.1 69.5-109 106.4-234.2 107-364h41.6z m0-64h-44.9C427.2 0 400 27.2 400 60.7c0 127.1-39.1 251.2-112 355.3v484.1c0 68.4 55.5 123.9 123.9 123.9h317c122.7 0 227.2-89.3 246.3-210.5l47.9-303.4c7.8-49.4-30.4-94.1-80.4-94.1H671.6c-50.9 0-90.5-44.4-84.6-95l23.5-203.4C617.7 55 568.7 0 505.6 0z" fill="#ccc"></path>
        </svg>
      </div>
      <div class="zan-list">
        <div style="display: flex; align-items: center;">
          <div style="width: 24px; height: 24px; background: #f0f0f0; border-radius: 50%; margin-right: 5px;" v-for="i in 3" :key="i"></div>
          <div style="margin-left:10px; height: 16px; background: #f0f0f0; border-radius: 4px; width: 60px;"></div>
        </div>
      </div>
    </div>

    <div v-else class="zan-box">
      <div>
        <svg t="1646634642977" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2187" width="20" height="20">
          <path d="M160 944c0 8.8-7.2 16-16 16h-32c-26.5 0-48-21.5-48-48V528c0-26.5 21.5-48 48-48h32c8.8 0 16 7.2 16 16v448zM96 416c-53 0-96 43-96 96v416c0 53 43 96 96 96h96c17.7 0 32-14.3 32-32V448c0-17.7-14.3-32-32-32H96zM505.6 64c16.2 0 26.4 8.7 31 13.9 4.6 5.2 12.1 16.3 10.3 32.4l-23.5 203.4c-4.9 42.2 8.6 84.6 36.8 116.4 28.3 31.7 68.9 49.9 111.4 49.9h271.2c6.6 0 10.8 3.3 13.2 6.1s5 7.5 4 14l-48 303.4c-6.9 43.6-29.1 83.4-62.7 112C815.8 944.2 773 960 728.9 960h-317c-33.1 0-59.9-26.8-59.9-59.9v-455c0-6.1 1.7-12 5-17.1 69.5-109 106.4-234.2 107-364h41.6z m0-64h-44.9C427.2 0 400 27.2 400 60.7c0 127.1-39.1 251.2-112 355.3v484.1c0 68.4 55.5 123.9 123.9 123.9h317c122.7 0 227.2-89.3 246.3-210.5l47.9-303.4c7.8-49.4-30.4-94.1-80.4-94.1H671.6c-50.9 0-90.5-44.4-84.6-95l23.5-203.4C617.7 55 568.7 0 505.6 0z" p-id="2188" :fill="blog.isLike ? '#ff6633' : '#82848a'"></path>
        </svg>
      </div>
      <div class="zan-list">
        <div class="user-icon-mini" v-for="u in likes" :key="u.id">
          <img :src="u.icon || '/imgs/icons/default-icon.png'" alt="">
        </div>
        <div style="margin-left:10px;text-align: center;line-height: 24px;">{{blog.liked || 0}}äººç‚¹èµ</div>
      </div>
    </div>
    <div class="blog-divider"></div>
    <div class="blog-comments">
      <div class="comments-head">
        <div>ç½‘å‹è¯„ä»· <span>ï¼ˆ{{commentsTotal || blog.comments || comments.list.length || 0}}ï¼‰</span></div>
        <div><i class="el-icon-arrow-right"></i></div>
      </div>

      <!-- è¯„è®ºåŠ è½½çŠ¶æ€ -->
      <div v-if="comments.loading" style="text-align: center; padding: 20px;">
        <i class="el-icon-loading" style="font-size: 20px; color: #409EFF;"></i>
        <div style="margin-top: 10px; color: #666;">åŠ è½½è¯„è®ºä¸­...</div>
      </div>

      <!-- è¯„è®ºé”™è¯¯çŠ¶æ€ -->
      <div v-else-if="comments.error" style="text-align: center; padding: 20px;">
        <i class="el-icon-warning" style="font-size: 20px; color: #F56C6C;"></i>
        <div style="margin-top: 10px; color: #666;">{{comments.errorMsg}}</div>
        <el-button size="mini" @click="loadComments" style="margin-top: 10px;">é‡è¯•</el-button>
      </div>

      <!-- è¯„è®ºåˆ—è¡¨ -->
      <div v-else class="comment-list">
        <!-- æ— è¯„è®ºçŠ¶æ€ -->
        <div v-if="comments.list.length === 0" style="text-align: center; padding: 20px; color: #999;">
          <i class="el-icon-chat-dot-round" style="font-size: 24px;"></i>
          <div style="margin-top: 10px;">æš‚æ— è¯„è®ºï¼Œå¿«æ¥æŠ¢æ²™å‘å§~</div>
        </div>

        <!-- è¯„è®ºé¡¹ -->
        <div v-else>
          <div class="comment-box" v-for="comment in comments.list" :key="comment.id">
            <div class="comment-icon">
              <img :src="comment.userIcon || '/imgs/icons/default-icon.png'" alt="">
            </div>
            <div class="comment-info">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div class="comment-user">{{comment.userNickName || 'åŒ¿åç”¨æˆ·'}}</div>
                <div v-if="user && user.id === comment.userId" style="color: #999; font-size: 12px; cursor: pointer;" @click="deleteComment(comment)">
                  <i class="el-icon-delete"></i>
                </div>
              </div>
              <div style="padding: 5px 0; font-size: 14px">
                {{comment.content}}
              </div>
              <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                <div style="color: #999; font-size: 12px;">
                  {{formatCommentTime(comment.createTime)}}
                </div>
                <div style="display: flex; align-items: center;">
                  <span style="color: #999; font-size: 12px; margin-right: 15px; cursor: pointer;" @click="showCommentInput(comment)">
                    <i class="el-icon-chat-dot-round"></i> å›å¤ {{comment.replies ? comment.replies.length : 0}}
                  </span>
                  <span style="color: #999; font-size: 12px; cursor: pointer;" @click="likeComment(comment)">
                    <i :class="comment.isLiked ? 'el-icon-star-on' : 'el-icon-star-off'"
                       :style="{color: comment.isLiked ? '#ff6633' : '#999'}"></i>
                    {{comment.liked || 0}}
                  </span>
                </div>
              </div>

              <!-- å›å¤åˆ—è¡¨ -->
              <div v-if="comment.replies && comment.replies.length > 0" style="margin-top: 10px; padding-left: 20px; border-left: 2px solid #f0f0f0;">
                <div v-for="reply in comment.replies" :key="reply.id" style="margin-bottom: 10px; padding: 8px; background: #f9f9f9; border-radius: 4px;">
                  <div style="font-size: 12px; color: #666; margin-bottom: 5px;">
                    <strong>{{reply.userNickName || 'åŒ¿åç”¨æˆ·'}}</strong>
                    <span style="margin-left: 10px;">{{formatCommentTime(reply.createTime)}}</span>
                  </div>
                  <div style="font-size: 13px;">{{reply.content}}</div>
                </div>
              </div>
            </div>
          </div>

          <!-- æŸ¥çœ‹æ›´å¤šè¯„è®º -->
          <div v-if="(commentsTotal || blog.comments || comments.total || 0) > comments.list.length"
              style="display: flex; justify-content: space-between;padding: 15px 0; border-top: 1px solid #f1f1f1; margin-top: 10px; cursor: pointer;"
              @click="loadMoreComments">
            <div>æŸ¥çœ‹å…¨éƒ¨{{commentsTotal || blog.comments || comments.total || comments.list.length || 0}}æ¡è¯„ä»·</div>
            <div><i class="el-icon-arrow-right"></i></div>
          </div>
        </div>
      </div>
    </div>
    <div class="blog-divider"></div>
  </div>
  <div class="foot">
    <div class="foot-box">
      <div class="foot-view"  @click="addLike()">
        <svg t="1646634642977" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2187" width="26" height="26">
          <path d="M160 944c0 8.8-7.2 16-16 16h-32c-26.5 0-48-21.5-48-48V528c0-26.5 21.5-48 48-48h32c8.8 0 16 7.2 16 16v448zM96 416c-53 0-96 43-96 96v416c0 53 43 96 96 96h96c17.7 0 32-14.3 32-32V448c0-17.7-14.3-32-32-32H96zM505.6 64c16.2 0 26.4 8.7 31 13.9 4.6 5.2 12.1 16.3 10.3 32.4l-23.5 203.4c-4.9 42.2 8.6 84.6 36.8 116.4 28.3 31.7 68.9 49.9 111.4 49.9h271.2c6.6 0 10.8 3.3 13.2 6.1s5 7.5 4 14l-48 303.4c-6.9 43.6-29.1 83.4-62.7 112C815.8 944.2 773 960 728.9 960h-317c-33.1 0-59.9-26.8-59.9-59.9v-455c0-6.1 1.7-12 5-17.1 69.5-109 106.4-234.2 107-364h41.6z m0-64h-44.9C427.2 0 400 27.2 400 60.7c0 127.1-39.1 251.2-112 355.3v484.1c0 68.4 55.5 123.9 123.9 123.9h317c122.7 0 227.2-89.3 246.3-210.5l47.9-303.4c7.8-49.4-30.4-94.1-80.4-94.1H671.6c-50.9 0-90.5-44.4-84.6-95l23.5-203.4C617.7 55 568.7 0 505.6 0z" p-id="2188" :fill="blog.isLike ? '#ff6633' : '#82848a'"></path>
        </svg>
        <span :class="{liked: blog.isLike}">{{blog.liked}}</span>
      </div>
    </div>
    <div style="width: 40%">
    </div>
    <div class="foot-box">
      <div class="foot-view" @click="showCommentInput"><i class="el-icon-chat-square"></i></div>
    </div>
  </div>

  <!-- è¯„è®ºè¾“å…¥æ¡† -->
  <div v-if="commentInput.show" class="comment-input-overlay" @click="hideCommentInput">
    <div class="comment-input-container" @click.stop>
      <div class="comment-input-header">
        <span v-if="commentInput.parentId === 0">å‘è¡¨è¯„è®º</span>
        <span v-else>å›å¤ {{commentInput.parentComment?.userNickName || 'ç”¨æˆ·'}}</span>
        <i class="el-icon-close" @click="hideCommentInput"></i>
      </div>
      <div class="comment-input-body">
        <el-input
          type="textarea"
          v-model="commentInput.content"
          :placeholder="commentInput.placeholder"
          :rows="4"
          maxlength="500"
          show-word-limit
          resize="none">
        </el-input>
      </div>
      <div class="comment-input-footer">
        <el-button @click="hideCommentInput">å–æ¶ˆ</el-button>
        <el-button
          type="primary"
          @click="submitComment"
          :loading="commentInput.submitting"
          :disabled="!commentInput.content.trim()">
          å‘å¸ƒ
        </el-button>
      </div>
    </div>
  </div>

  <!-- å›¾ç‰‡æ”¾å¤§æŸ¥çœ‹æ¨¡æ€æ¡† -->
  <div v-if="imageModal.show" class="image-modal-overlay" @click="hideImageModal">
    <div class="image-modal-close" @click="hideImageModal">
      <i class="el-icon-close"></i>
    </div>
    <img :src="imageModal.src" alt="" class="image-modal-content" @click.stop>
  </div>
</div>
<script src="./js/vue.js"></script>
<script src="./js/axios.min.js"></script>
<!-- å¼•å…¥ç»„ä»¶åº“ -->
<script src="./js/element.js"></script>
<script src="./js/loading.js"></script>
<script src="./js/message.js"></script>
<script src="./js/performance.js"></script>
<script src="./js/common.js"></script>
<script>
  console.log("=== é¡µé¢è„šæœ¬å¼€å§‹æ‰§è¡Œ ===");
  console.log("Vueæ˜¯å¦å­˜åœ¨:", typeof Vue);
  console.log("axiosæ˜¯å¦å­˜åœ¨:", typeof axios);
  console.log("utilæ˜¯å¦å­˜åœ¨:", typeof util);
  console.log("ELEMENTæ˜¯å¦å­˜åœ¨:", typeof ELEMENT);
  console.log("å½“å‰document.readyState:", document.readyState);
  let each = function (ary, callback) {
    for (let i = 0, l = ary.length; i < l; i++) {
      if (callback(ary[i], i) === false) break
    }
  }
  console.log("=== å¼€å§‹åˆ›å»ºVueå®ä¾‹ ===");
  console.log("Vueæ˜¯å¦å¯ç”¨:", typeof Vue !== 'undefined');
  console.log("axiosæ˜¯å¦å¯ç”¨:", typeof axios !== 'undefined');
  console.log("utilæ˜¯å¦å¯ç”¨:", typeof util !== 'undefined');

  try {
    console.log("=== è¿›å…¥tryå— ===");
    console.log("å‡†å¤‡åˆ›å»ºVueå®ä¾‹...");
    const app = new Vue({
    el: "#app",
    data: {
      util,
      blog: {
        title: '',
        content: '',
        images: [],
        liked: 0,
        isLike: false,
        userId: null,
        shopId: null,
        icon: '',
        name: '',
        createTime: null,
        comments: 0  // æ·»åŠ è¯„è®ºæ€»æ•°å­—æ®µï¼ˆä¸åç«¯å­—æ®µåä¸€è‡´ï¼‰
      },
      shop: {},
      likes: [],
      user: {}, // ç™»å½•ç”¨æˆ·
      followed: false, // æ˜¯å¦å…³æ³¨äº†
      // è¯„è®ºç›¸å…³çŠ¶æ€
      comments: {
        list: [],
        total: 0,
        loading: false,
        error: false,
        errorMsg: '',
        page: 1,
        size: 5
      },
      // è¯„è®ºè¾“å…¥ç›¸å…³çŠ¶æ€
      commentInput: {
        show: false,
        content: '',
        parentId: 0,
        parentComment: null,
        placeholder: 'å†™ä¸‹ä½ çš„è¯„è®º...',
        submitting: false
      },
      // å›¾ç‰‡æ¨¡æ€æ¡†ç›¸å…³çŠ¶æ€
      imageModal: {
        show: false,
        src: ''
      },
      // é¡µé¢åŠ è½½çŠ¶æ€
      pageLoading: {
        blog: false,
        shop: false,
        likes: false,
        user: false
      },
      _width: 0,
      duration: 300,
      container: null,
      items: [],
      active: 0,
      start: {
        x: 0,
        y: 0
      },
      move: {
        x: 0,
        y: 0
      },
      sensitivity: 60,
      resistance: 0.3
    },
    computed: {
      shopScore: {
        get() {
          return this.shop.score ? this.shop.score/10 : 0;
        },
        set(val) {
          if(this.shop.score) {
            this.shop.score = val * 10;
          }
        }
      },
      // è®¡ç®—è¯„è®ºæ€»æ•°ï¼Œç¡®ä¿æ˜¾ç¤ºæ­£ç¡®
      commentsTotal() {
        // è·å–å„ç§å¯èƒ½çš„æ•°æ®æº
        const apiTotal = this.comments.total;
        const listLength = this.comments.list ? this.comments.list.length : 0;
        const blogCommentsCount = this.blog.comments;  // ä½¿ç”¨æ­£ç¡®çš„å­—æ®µå

        console.log("è®¡ç®—è¯„è®ºæ€»æ•° - API total:", apiTotal, "åˆ—è¡¨é•¿åº¦:", listLength, "åšå®¢è¯„è®ºæ•°:", blogCommentsCount);

        // æ–¹æ¡ˆ1ï¼šä¼˜å…ˆä½¿ç”¨åšå®¢æ•°æ®ä¸­çš„è¯„è®ºæ€»æ•°ï¼ˆåç«¯æä¾›çš„å‡†ç¡®æ•°æ®ï¼‰
        if (typeof blogCommentsCount === 'number' && blogCommentsCount >= 0) {
          console.log("ä½¿ç”¨åšå®¢æ•°æ®ä¸­çš„è¯„è®ºæ€»æ•°:", blogCommentsCount);
          return blogCommentsCount;
        }

        // æ–¹æ¡ˆ2ï¼šä½¿ç”¨APIè¿”å›çš„totalï¼ˆå¦‚æœæ˜¯æœ‰æ•ˆæ•°å­—ï¼‰
        if (typeof apiTotal === 'number' && apiTotal >= 0) {
          console.log("ä½¿ç”¨APIè¿”å›çš„total:", apiTotal);
          return apiTotal;
        }

        // æ–¹æ¡ˆ3ï¼šä½¿ç”¨å½“å‰åŠ è½½çš„è¯„è®ºåˆ—è¡¨é•¿åº¦ä½œä¸ºå¤‡ç”¨
        console.log("ä½¿ç”¨è¯„è®ºåˆ—è¡¨é•¿åº¦ä½œä¸ºå¤‡ç”¨:", listLength);
        return listLength;
      }
    },
    created() {
      console.log("=== Vueå®ä¾‹createdé’©å­æ‰§è¡Œ ===");
      console.log("thiså¯¹è±¡:", this);
      console.log("utilå¯¹è±¡:", util);
      let id = util.getUrlParam("id");
      console.log("è·å–åˆ°çš„åšå®¢ID:", id);
      if (id) {
        console.log("=== å¼€å§‹è°ƒç”¨queryBlogById ===");
        this.queryBlogById(id);
        console.log("=== å¼€å§‹è°ƒç”¨loadComments ===");
        this.loadComments(id);
      } else {
        console.error("ç¼ºå°‘åšå®¢IDå‚æ•°");
        this.$message.error("ç¼ºå°‘åšå®¢IDå‚æ•°");
      }
    },
    mounted() {
      console.log("=== Vueå®ä¾‹mountedé’©å­æ‰§è¡Œ ===");
      console.log("DOMå·²æŒ‚è½½ï¼Œblogæ•°æ®:", this.blog);
      console.log("pageLoadingçŠ¶æ€:", this.pageLoading);
    },
    methods: {
      init() {
        // è·å¾—çˆ¶å®¹å™¨èŠ‚ç‚¹
        this.container = this.$refs.swiper
        // æ£€æŸ¥å®¹å™¨æ˜¯å¦å­˜åœ¨
        if (!this.container) {
          console.warn('è½®æ’­å›¾å®¹å™¨ä¸å­˜åœ¨ï¼Œè·³è¿‡åˆå§‹åŒ–');
          return;
        }
        // è·å¾—æ‰€æœ‰çš„å­èŠ‚ç‚¹
        this.items = this.container.querySelectorAll('.swiper-item')
        
        // æ·»åŠ å›¾ç‰‡åŠ è½½å®Œæˆçš„äº‹ä»¶å¤„ç†
        if (this.items && this.items.length > 0) {
          this.items.forEach(item => {
            const img = item.querySelector('img');
            if (img) {
              // å¦‚æœå›¾ç‰‡å·²ç»åŠ è½½å®Œæˆ
              if (img.complete) {
                console.log('å›¾ç‰‡å·²åŠ è½½å®Œæˆï¼Œè°ƒæ•´å®¹å™¨é«˜åº¦');
                this.updateContainerHeight(img);
              }
              // å›¾ç‰‡åŠ è½½å®Œæˆæ—¶æ›´æ–°
              img.onload = () => {
                console.log('å›¾ç‰‡åŠ è½½å®Œæˆï¼Œè°ƒæ•´å®¹å™¨é«˜åº¦');
                this.updateContainerHeight(img);
                this.updateItemWidth();
                this.setTransform();
              }
            }
          });
        }
        
        this.updateItemWidth()
        this.setTransform()
        this.setTransition('none')
      },

      // åŠ¨æ€é«˜åº¦è½®æ’­åˆå§‹åŒ–
      initDynamicSwiper() {
        this.container = this.$refs.swiper;
        if (!this.container) return;

        this.items = this.container.querySelectorAll('.swiper-item');
        if (this.items.length <= 1) return;

        // æ˜¾ç¤ºç¬¬ä¸€å¼ å›¾ç‰‡ï¼Œéšè—å…¶ä»–å›¾ç‰‡
        this.items.forEach((item, index) => {
          if (index === 0) {
            item.style.display = 'block';
          } else {
            item.style.display = 'none';
          }
        });

        this.active = 0;
      },
      
      // æ›´æ–°å®¹å™¨é«˜åº¦é€‚åº”å›¾ç‰‡
      updateContainerHeight(img) {
        if (!this.container || !img) return;

        // è·å–å›¾ç‰‡çš„åŸå§‹å°ºå¯¸
        const imgWidth = img.naturalWidth;
        const imgHeight = img.naturalHeight;

        if (imgWidth && imgHeight) {
          // è®¡ç®—å®½é«˜æ¯”
          const ratio = imgHeight / imgWidth;

          // è·å–å®¹å™¨å®½åº¦
          const containerWidth = this.container.offsetWidth;

          // è®¡ç®—åˆé€‚çš„é«˜åº¦ï¼Œç§»é™¤æœ€å¤§é«˜åº¦é™åˆ¶ï¼Œè®©å›¾ç‰‡å®Œæ•´æ˜¾ç¤º
          let newHeight = containerWidth * ratio;
          newHeight = Math.max(newHeight, 500); // å¢åŠ æœ€å°é«˜åº¦ä¿è¯ 200px * 2.5 = 500px

          console.log('è°ƒæ•´å®¹å™¨é«˜åº¦:', newHeight, 'å›¾ç‰‡å°ºå¯¸:', imgWidth, 'x', imgHeight);
          this.container.style.height = newHeight + 'px';
        }
      },

      goBack() {
        history.back();
      },
      toOtherInfo(){
        if(this.blog.userId === this.user.id){
          location.href = "/user-info.html"
        }else{
          location.href = "/user-other-info.html?id=" + this.blog.userId
        }
      },
      queryBlogById(id) {
        if (!id) {
          this.$message.error("åšå®¢IDä¸èƒ½ä¸ºç©º");
          return;
        }

        console.log("å¼€å§‹æŸ¥è¯¢åšå®¢è¯¦æƒ…ï¼ŒID:", id);
        this.pageLoading.blog = true;
        axios.get("/blog/" + id)
          .then((data) => {
            console.log("åšå®¢æ•°æ®è·å–æˆåŠŸ:", data);
            const blogData = data.data;
            console.log("åšå®¢æ•°æ®è¯¦æƒ…:", blogData);
            console.log("åšå®¢è¯„è®ºæ•°é‡å­—æ®µ:", blogData.comments);
            
            // å¤„ç†åšå®¢æ•°æ®
            if (blogData) {
              // å¤„ç†å›¾ç‰‡
              if (blogData.images) {
                blogData.images = blogData.images.split(",");
                
                // é¢„åŠ è½½å›¾ç‰‡
                if (blogData.images.length > 0) {
                  const preloadImages = [];
                  blogData.images.forEach(imgSrc => {
                    const img = new Image();
                    img.src = imgSrc;
                    img.onload = () => {
                      console.log('å›¾ç‰‡é¢„åŠ è½½å®Œæˆ:', imgSrc);
                    };
                    preloadImages.push(img);
                  });
                }
              } else {
                blogData.images = [];
              }
              
              // å¤„ç†æ ‡é¢˜å’Œå†…å®¹
              if (blogData.content) {
                // æ£€æŸ¥æ˜¯å¦å·²æœ‰æ ‡é¢˜
                if (!blogData.title) {
                  // ç‰¹æ®Šå¤„ç†: æ£€æŸ¥æ˜¯å¦åŒ…å«"æ­å·å‘¨æœ«å¥½å»å¤„ï½œğŸ’°50å°±å¯ä»¥éª‘é©¬å•¦ğŸ"æ ¼å¼çš„å†…å®¹
                  const specialFormatMatch = blogData.content.match(/æ­å·å‘¨æœ«å¥½å»å¤„ï½œğŸ’°[\d]+å°±å¯ä»¥éª‘é©¬å•¦ğŸ/);
                  if (specialFormatMatch) {
                    blogData.title = specialFormatMatch[0].trim();
                    blogData.content = blogData.content.replace(specialFormatMatch[0], '').trim();
                  } else {
                    // å°è¯•ä»å†…å®¹ä¸­æå–æ ‡é¢˜
                    // æ–¹æ³•1: æ£€æŸ¥ç¬¬ä¸€ä¸ªdivæ ‡ç­¾å†…å®¹
                    let contentMatch = blogData.content.match(/<div[^>]*>(.*?)<\/div>/);
                    if (contentMatch && contentMatch[1]) {
                      blogData.title = contentMatch[1].trim();
                      // ä»å†…å®¹ä¸­ç§»é™¤æ ‡é¢˜éƒ¨åˆ†
                      blogData.content = blogData.content.replace(contentMatch[0], '').trim();
                    } else {
                      // æ–¹æ³•2: æ£€æŸ¥ç¬¬ä¸€è¡Œæ–‡æœ¬
                      contentMatch = blogData.content.match(/^([^<>\n]+)/);
                      if (contentMatch && contentMatch[1]) {
                        blogData.title = contentMatch[1].trim();
                        // ä»å†…å®¹ä¸­ç§»é™¤æ ‡é¢˜éƒ¨åˆ†
                        blogData.content = blogData.content.replace(contentMatch[1], '').trim();
                      }
                    }
                  }
                }
              }
            }

            this.blog = blogData;
            console.log("åšå®¢æ•°æ®å·²èµ‹å€¼:", this.blog);
            console.log("åšå®¢è¯„è®ºæ•°é‡:", this.blog.comments);
            
            // åªæœ‰å½“åšå®¢æœ‰å›¾ç‰‡æ—¶æ‰åˆå§‹åŒ–è½®æ’­å›¾
            if (this.blog.images && this.blog.images.length > 0) {
              this.$nextTick(() => {
                // ç¡®ä¿DOMå·²ç»æ›´æ–°å¹¶ä¸”swiperå®¹å™¨å­˜åœ¨
                if (this.$refs.swiper) {
                  if (this.$refs.swiper.classList.contains('dynamic-height')) {
                    this.initDynamicSwiper();
                  } else {
                    this.init();
                  }
                } else {
                  console.warn('è½®æ’­å›¾å®¹å™¨æœªæ‰¾åˆ°ï¼Œå¯èƒ½æ˜¯DOMå°šæœªæ›´æ–°');
                }
              });
            }

            // åŠ è½½ç›¸å…³æ•°æ®
            if (data.shopId) {
              this.queryShopById(data.shopId);
            }
            this.queryLikeList(id);
            this.queryLoginUser();
          })
          .catch(err => {
            console.error("è·å–åšå®¢è¯¦æƒ…å¤±è´¥:", err);
            this.$message.error("è·å–åšå®¢è¯¦æƒ…å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•");
          })
          .finally(() => {
            this.pageLoading.blog = false;
          })
      },
      queryShopById(shopId) {
        if (!shopId) {
          console.warn("å•†åº—IDä¸ºç©ºï¼Œè·³è¿‡å•†åº—ä¿¡æ¯æŸ¥è¯¢");
          return;
        }

        this.pageLoading.shop = true;
        axios.get("/shop/" + shopId)
          .then((data) => {
            const shopData = data.data;
            if (shopData && shopData.images) {
              shopData.image = shopData.images.split(",")[0];
            } else {
              shopData.image = "";
            }
            this.shop = shopData;
          })
          .catch(err => {
            console.error("è·å–å•†åº—ä¿¡æ¯å¤±è´¥:", err);
            this.$message.error("è·å–å•†åº—ä¿¡æ¯å¤±è´¥");
          })
          .finally(() => {
            this.pageLoading.shop = false;
          })
      },
      queryLikeList(id){
        if (!id) {
          console.warn("åšå®¢IDä¸ºç©ºï¼Œè·³è¿‡ç‚¹èµåˆ—è¡¨æŸ¥è¯¢");
          return;
        }

        this.pageLoading.likes = true;
        axios.get("/blog/likes/" + id)
          .then((data) => {
            this.likes = data.data || [];
          })
          .catch(err => {
            console.error("è·å–ç‚¹èµåˆ—è¡¨å¤±è´¥:", err);
            this.likes = [];
          })
          .finally(() => {
            this.pageLoading.likes = false;
          })
      },
      addLike(){
        if (!this.blog.id) {
          this.$message.error("åšå®¢ä¿¡æ¯å¼‚å¸¸ï¼Œæ— æ³•ç‚¹èµ");
          return;
        }

        axios.put("/blog/like/" + this.blog.id)
          .then((data) => {
            // é‡æ–°è·å–åšå®¢ä¿¡æ¯å’Œç‚¹èµåˆ—è¡¨
            axios.get("/blog/" + this.blog.id)
              .then((blogData) => {
                const updatedBlogData = blogData.data;
                if (updatedBlogData && updatedBlogData.images) {
                  updatedBlogData.images = updatedBlogData.images.split(",");
                } else {
                  updatedBlogData.images = [];
                }
                this.blog = updatedBlogData;
                this.queryLikeList(this.blog.id);
                this.$message.success(updatedBlogData.isLike ? "ç‚¹èµæˆåŠŸ" : "å–æ¶ˆç‚¹èµæˆåŠŸ");
              })
              .catch(err => {
                console.error("è·å–æ›´æ–°åçš„åšå®¢ä¿¡æ¯å¤±è´¥:", err);
                this.$message.error("ç‚¹èµçŠ¶æ€æ›´æ–°å¤±è´¥");
              })
          })
          .catch(err => {
            console.error("ç‚¹èµæ“ä½œå¤±è´¥:", err);
            this.$message.error("ç‚¹èµæ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•");
          })
      },
      isFollowed(){
        axios.get("/follow/or/not/" + this.blog.userId)
          .then((data) => {
            this.followed = data.data;
          })
          .catch(err => {
            console.error("è·å–å…³æ³¨çŠ¶æ€å¤±è´¥:", err);
          })
      },
      follow(){
        axios.put("/follow/" + this.blog.userId + "/" + !this.followed)
          .then((data) => {
            this.$message.success(this.followed ? "å·²å–æ¶ˆå…³æ³¨" : "å·²å…³æ³¨")
            this.followed = !this.followed
          })
          .catch(err => {
            console.error("å…³æ³¨æ“ä½œå¤±è´¥:", err);
            this.$message.error("å…³æ³¨æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•");
          })
      },
      formatTime(b) {
        return b.getFullYear() + "å¹´" + (b.getMonth() + 1) + "æœˆ" + b.getDate() + "æ—¥ ";
      },
      formatMinutes(m) {
        if (m < 10) m = "0" + m
        return m;
      },
      queryLoginUser(){
        this.pageLoading.user = true;
        // æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
        axios.get("/user/me")
          .then((data) => {
            // ä¿å­˜ç”¨æˆ·
            this.user = data.data || {};
            if(this.user.id && this.blog.userId && this.user.id !== this.blog.userId){
              this.isFollowed();
            }
          })
          .catch(err => {
            console.log("è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:", err);
            this.user = {};
          })
          .finally(() => {
            this.pageLoading.user = false;
          })
      },

      // ========== å›¾ç‰‡æ¨¡æ€æ¡†ç›¸å…³æ–¹æ³• ==========

      /**
       * æ˜¾ç¤ºå›¾ç‰‡æ”¾å¤§æŸ¥çœ‹
       */
      showImageModal(imageSrc) {
        this.imageModal.show = true;
        this.imageModal.src = imageSrc;
        // é˜»æ­¢é¡µé¢æ»šåŠ¨
        document.body.style.overflow = 'hidden';
      },

      /**
       * éšè—å›¾ç‰‡æ”¾å¤§æŸ¥çœ‹
       */
      hideImageModal() {
        this.imageModal.show = false;
        this.imageModal.src = '';
        // æ¢å¤é¡µé¢æ»šåŠ¨
        document.body.style.overflow = 'auto';
      },

      // ========== è¯„è®ºç›¸å…³æ–¹æ³• ==========

      /**
       * åŠ è½½è¯„è®ºåˆ—è¡¨
       */
      loadComments(blogId) {
        const id = blogId || util.getUrlParam("id");
        if (!id) {
          console.warn("åšå®¢IDä¸ºç©ºï¼Œæ— æ³•åŠ è½½è¯„è®º");
          return;
        }

        console.log("=== å¼€å§‹åŠ è½½è¯„è®º ===");
        console.log("åšå®¢ID:", id);
        console.log("å½“å‰é¡µç :", this.comments.page);
        console.log("æ¯é¡µå¤§å°:", this.comments.size);

        this.comments.loading = true;
        this.comments.error = false;
        this.comments.errorMsg = '';

        const apiUrl = `/blog-comments/blog/${id}?page=${this.comments.page}&size=${this.comments.size}`;
        console.log("APIè¯·æ±‚URL:", apiUrl);

        axios.get(apiUrl)
          .then((response) => {
            console.log("=== APIå“åº”æˆåŠŸ ===");
            console.log("å®Œæ•´å“åº”å¯¹è±¡:", response);
            
            // æ£€æŸ¥å“åº”æ ¼å¼å¹¶å¤„ç†ä¸åŒç±»å‹çš„å“åº”
            let responseData = response;
            let records = null;
            let total = null;
            
            // é¦–å…ˆå°è¯•æ‰¾åˆ°è¯„è®ºæ•°æ®
            // æƒ…å†µ1: æ ‡å‡†Result<T>æ ¼å¼ {success: true, data: {records: [...], total: 10}}
            if (responseData.success === true && responseData.data && responseData.data.records) {
              console.log("æ ‡å‡†Result<T>æ ¼å¼å“åº”");
              records = responseData.data.records;
              total = responseData.data.total;
            }
            // æƒ…å†µ2: å“åº”ä¸­æœ‰dataå­—æ®µï¼Œä½†æ²¡æœ‰successå­—æ®µ {data: {records: [...], total: 10}}
            else if (responseData.data && responseData.data.records) {
              console.log("åŒ…å«dataå­—æ®µçš„å“åº”");
              records = responseData.data.records;
              total = responseData.data.total;
            }
            // æƒ…å†µ3: å“åº”æœ¬èº«å°±æ˜¯åˆ†é¡µæ•°æ®ï¼ˆæ²¡æœ‰dataåŒ…è£…ï¼Œä½†æœ‰recordså­—æ®µï¼‰{records: [...], total: 10}
            else if (responseData.records) {
              console.log("ç›´æ¥åˆ†é¡µæ•°æ®æ ¼å¼");
              records = responseData.records;
              total = responseData.total;
            }
            // æƒ…å†µ4: å“åº”æ˜¯æ•°ç»„ [...]
            else if (Array.isArray(responseData)) {
              console.log("å“åº”ç›´æ¥æ˜¯æ•°ç»„");
              records = responseData;
              total = responseData.length;
            }
            // æƒ…å†µ5: å…¶ä»–æœªçŸ¥æ ¼å¼ï¼Œå°è¯•æ™ºèƒ½å¤„ç†
            else {
              console.warn("æœªçŸ¥å“åº”æ ¼å¼ï¼Œå°è¯•æ™ºèƒ½è§£æ:", responseData);
              
              // å°è¯•æŸ¥æ‰¾å¯èƒ½çš„æ•°ç»„å­—æ®µ
              for (const key in responseData) {
                if (Array.isArray(responseData[key])) {
                  console.log("æ‰¾åˆ°å¯èƒ½çš„è¯„è®ºæ•°ç»„å­—æ®µ:", key);
                  records = responseData[key];
                  break;
                }
              }
              
              // å°è¯•æŸ¥æ‰¾å¯èƒ½çš„æ€»æ•°å­—æ®µ
              for (const key in responseData) {
                if (typeof responseData[key] === 'number' && 
                   (key.toLowerCase().includes('total') || key.toLowerCase().includes('count'))) {
                  console.log("æ‰¾åˆ°å¯èƒ½çš„æ€»æ•°å­—æ®µ:", key);
                  total = responseData[key];
                  break;
                }
              }
              
              // å¦‚æœæ²¡æœ‰æ‰¾åˆ°æ€»æ•°ï¼Œä½¿ç”¨æ•°ç»„é•¿åº¦
              if (records && total === null) {
                total = records.length;
                console.log("ä½¿ç”¨æ•°ç»„é•¿åº¦ä½œä¸ºæ€»æ•°:", total);
              }
            }
            
            // å¦‚æœæ— æ³•æ‰¾åˆ°è¯„è®ºæ•°æ®
            if (!records) {
              console.warn("æ— æ³•ä»å“åº”ä¸­æå–è¯„è®ºæ•°æ®");
              this.comments.list = [];
              this.comments.total = 0;
              this.comments.error = true;
              this.comments.errorMsg = "æ— æ³•è§£æè¯„è®ºæ•°æ®";
              return;
            }
            
            // è®¾ç½®è¯„è®ºæ•°æ®
            this.comments.list = records;
            this.comments.total = total !== null ? total : records.length;
            
            // æ•°æ®ç±»å‹éªŒè¯
            if (typeof this.comments.total !== 'number' || this.comments.total < 0) {
              console.warn("è¯„è®ºæ€»æ•°æ— æ•ˆï¼Œä½¿ç”¨è®°å½•æ•°é‡ä½œä¸ºå¤‡ç”¨");
              this.comments.total = this.comments.list.length;
            }

            // åŒæ­¥æ›´æ–°åšå®¢æ•°æ®ä¸­çš„è¯„è®ºæ€»æ•°
            if (this.blog) {
              this.blog.comments = this.comments.total;
            }

            // æ¸…é™¤é”™è¯¯çŠ¶æ€
            this.comments.error = false;
            this.comments.errorMsg = '';

            console.log("=== æœ€ç»ˆè®¾ç½®çš„è¯„è®ºæ•°æ® ===");
            console.log("è¯„è®ºåˆ—è¡¨:", this.comments.list);
            console.log("è¯„è®ºæ€»æ•°:", this.comments.total);

            // å¼ºåˆ¶è§¦å‘Vueå“åº”å¼æ›´æ–°
            this.$forceUpdate();

            // ç¡®ä¿DOMæ›´æ–°åå†æ¬¡éªŒè¯å’Œå¼ºåˆ¶æ›´æ–°
            this.$nextTick(() => {
              console.log("DOMæ›´æ–°åçš„è¯„è®ºæ€»æ•°:", this.comments.total);
              console.log("DOMæ›´æ–°åçš„åšå®¢è¯„è®ºæ•°:", this.blog.comments);
              console.log("DOMæ›´æ–°åçš„è®¡ç®—å±æ€§å€¼:", this.commentsTotal);

              const commentsHeadElement = document.querySelector('.comments-head span');
              if (commentsHeadElement) {
                console.log("DOMä¸­æ˜¾ç¤ºçš„è¯„è®ºæ•°é‡:", commentsHeadElement.textContent);
              }

              // å†æ¬¡å¼ºåˆ¶æ›´æ–°ä»¥ç¡®ä¿æ˜¾ç¤ºæ­£ç¡®
              this.$forceUpdate();
            });
          })
          .catch(err => {
            console.error("=== è·å–è¯„è®ºå¤±è´¥ ===");
            console.error("é”™è¯¯å¯¹è±¡:", err);
            console.error("é”™è¯¯å“åº”:", err.response);
            console.error("é”™è¯¯çŠ¶æ€ç :", err.response?.status);
            console.error("é”™è¯¯æ•°æ®:", err.response?.data);

            this.comments.error = true;
            this.comments.errorMsg = "è·å–è¯„è®ºå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•";
            this.comments.list = [];
            this.comments.total = 0;
            
            // æ˜¾ç¤ºé”™è¯¯æç¤º
            this.$message.error("è·å–è¯„è®ºå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•");
          })
          .finally(() => {
            this.comments.loading = false;
            console.log("=== è¯„è®ºåŠ è½½å®Œæˆ ===");
            console.log("æœ€ç»ˆè¯„è®ºçŠ¶æ€:", {
              list: this.comments.list,
              total: this.comments.total,
              loading: this.comments.loading,
              error: this.comments.error
            });
          })
      },

      /**
       * åŠ è½½æ›´å¤šè¯„è®º
       */
      loadMoreComments() {
        this.comments.page++;
        this.loadComments();
      },

      /**
       * æ ¼å¼åŒ–è¯„è®ºæ—¶é—´
       */
      formatCommentTime(timeStr) {
        if (!timeStr) return '';

        try {
          const time = new Date(timeStr);
          const now = new Date();
          const diff = now - time;

          // å°äº1åˆ†é’Ÿ
          if (diff < 60000) {
            return 'åˆšåˆš';
          }
          // å°äº1å°æ—¶
          if (diff < 3600000) {
            return Math.floor(diff / 60000) + 'åˆ†é’Ÿå‰';
          }
          // å°äº1å¤©
          if (diff < 86400000) {
            return Math.floor(diff / 3600000) + 'å°æ—¶å‰';
          }
          // å°äº7å¤©
          if (diff < 604800000) {
            return Math.floor(diff / 86400000) + 'å¤©å‰';
          }
          // è¶…è¿‡7å¤©æ˜¾ç¤ºå…·ä½“æ—¥æœŸ
          return time.getFullYear() + 'å¹´' + (time.getMonth() + 1) + 'æœˆ' + time.getDate() + 'æ—¥';
        } catch (e) {
          console.error("æ—¶é—´æ ¼å¼åŒ–å¤±è´¥:", e);
          return timeStr;
        }
      },

      /**
       * ç‚¹èµè¯„è®º
       */
      likeComment(comment) {
        if (!comment || !comment.id) {
          this.$message.error("è¯„è®ºä¿¡æ¯å¼‚å¸¸");
          return;
        }

        // é˜²æ­¢é‡å¤ç‚¹å‡»
        if (comment.liking) {
          return;
        }
        comment.liking = true;

        axios.put(`/blog-comments/like/${comment.id}`)
          .then((response) => {
            console.log("ç‚¹èµå“åº”:", response);
            
            // æ— è®ºå“åº”æ ¼å¼å¦‚ä½•ï¼Œåªè¦æ²¡æœ‰æ˜ç¡®çš„å¤±è´¥ä¿¡æ¯ï¼Œå°±è§†ä¸ºæˆåŠŸ
            if (response && response.success === false) {
              console.warn("ç‚¹èµå¤±è´¥:", response.errorMsg);
              this.$message.error(response.errorMsg || "ç‚¹èµå¤±è´¥");
              return;
            }

            // ä¸´æ—¶æ›´æ–°UIçŠ¶æ€ï¼Œæä¾›å³æ—¶åé¦ˆ
            comment.isLiked = !comment.isLiked;
            if (comment.isLiked) {
              comment.liked = (comment.liked || 0) + 1;
            } else {
              comment.liked = Math.max(0, (comment.liked || 1) - 1);
            }
            
            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            this.$message.success(comment.isLiked ? "ç‚¹èµæˆåŠŸ" : "å–æ¶ˆç‚¹èµæˆåŠŸ");
            
            // ä¸ºç¡®ä¿æ•°æ®ä¸€è‡´æ€§ï¼Œå»¶è¿Ÿé‡æ–°åŠ è½½è¯„è®º
            setTimeout(() => {
              this.loadComments();
            }, 300);
          })
          .catch(err => {
            console.error("è¯„è®ºç‚¹èµå¤±è´¥:", err);
            this.$message.error("ç‚¹èµå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•");
          })
          .finally(() => {
            comment.liking = false;
          })
      },

      /**
       * æ˜¾ç¤ºè¯„è®ºè¾“å…¥æ¡†
       */
      showCommentInput(parentComment = null) {
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç™»å½•
        if (!this.user || !this.user.id) {
          this.$message.warning("è¯·å…ˆç™»å½•åå†è¯„è®º");
          return;
        }

        this.commentInput.show = true;
        this.commentInput.content = '';

        if (parentComment) {
          // å›å¤è¯„è®º
          this.commentInput.parentId = parentComment.id;
          this.commentInput.parentComment = parentComment;
          this.commentInput.placeholder = `å›å¤ ${parentComment.userNickName || 'ç”¨æˆ·'}...`;
        } else {
          // å‘è¡¨æ–°è¯„è®º
          this.commentInput.parentId = 0;
          this.commentInput.parentComment = null;
          this.commentInput.placeholder = 'å†™ä¸‹ä½ çš„è¯„è®º...';
        }
      },

      /**
       * éšè—è¯„è®ºè¾“å…¥æ¡†
       */
      hideCommentInput() {
        this.commentInput.show = false;
        this.commentInput.content = '';
        this.commentInput.parentId = 0;
        this.commentInput.parentComment = null;
        this.commentInput.submitting = false;
      },

      /**
       * æäº¤è¯„è®º
       */
      submitComment() {
        if (!this.commentInput.content.trim()) {
          this.$message.warning("è¯·è¾“å…¥è¯„è®ºå†…å®¹");
          return;
        }

        if (!this.user || !this.user.id) {
          this.$message.warning("è¯·å…ˆç™»å½•åå†è¯„è®º");
          return;
        }

        const blogId = util.getUrlParam("id");
        if (!blogId) {
          this.$message.error("åšå®¢IDå¼‚å¸¸");
          return;
        }

        this.commentInput.submitting = true;

        const commentData = {
          blogId: parseInt(blogId),
          content: this.commentInput.content.trim(),
          parentId: this.commentInput.parentId
        };

        console.log("å‡†å¤‡æäº¤è¯„è®º:", commentData);

        axios.post('/blog-comments', commentData)
          .then((response) => {
            console.log("è¯„è®ºæäº¤å“åº”:", response);
            
            // æ£€æŸ¥æ˜¯å¦æœ‰æ˜ç¡®çš„å¤±è´¥ä¿¡æ¯
            if (response && response.success === false) {
              console.warn("è¯„è®ºå‘å¸ƒå¤±è´¥:", response.errorMsg);
              this.$message.error(response.errorMsg || "è¯„è®ºå‘å¸ƒå¤±è´¥");
              return;
            }
            
            this.$message.success("è¯„è®ºå‘å¸ƒæˆåŠŸ");
            this.hideCommentInput();

            // é‡æ–°åŠ è½½è¯„è®ºåˆ—è¡¨
            this.comments.page = 1; // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
            this.loadComments();

            // å‚è€ƒç‚¹èµåŠŸèƒ½ï¼Œé‡æ–°è·å–åšå®¢æ•°æ®ä»¥ç¡®ä¿è¯„è®ºæ€»æ•°å‡†ç¡®
            if (this.blog && this.blog.id) {
              axios.get("/blog/" + this.blog.id)
                .then((blogResponse) => {
                  console.log("è·å–æ›´æ–°åçš„åšå®¢æ•°æ®:", blogResponse);
                  
                  // å°è¯•ä»ä¸åŒæ ¼å¼çš„å“åº”ä¸­æå–åšå®¢æ•°æ®
                  let blogData = null;
                  if (blogResponse.data && blogResponse.success === true) {
                    blogData = blogResponse.data;
                  } else if (blogResponse.data) {
                    blogData = blogResponse.data;
                  } else {
                    blogData = blogResponse;
                  }
                  
                  if (blogData) {
                    // ä¿æŒå›¾ç‰‡æ•°æ®æ ¼å¼
                    if (blogData.images) {
                      if (typeof blogData.images === 'string') {
                        blogData.images = blogData.images.split(",");
                      }
                    } else {
                      blogData.images = [];
                    }
                    // æ›´æ–°åšå®¢æ•°æ®ï¼ŒåŒ…æ‹¬å¯èƒ½çš„è¯„è®ºæ€»æ•°
                    this.blog = Object.assign(this.blog, blogData);
                  }
                })
                .catch(err => {
                  console.error("è·å–æ›´æ–°åçš„åšå®¢ä¿¡æ¯å¤±è´¥:", err);
                });
            }

            // æ»šåŠ¨åˆ°è¯„è®ºåŒºåŸŸ
            this.$nextTick(() => {
              const commentsElement = document.querySelector('.blog-comments');
              if (commentsElement) {
                commentsElement.scrollIntoView({ behavior: 'smooth' });
              }
            });
          })
          .catch(err => {
            console.error("è¯„è®ºå‘å¸ƒå¤±è´¥:", err);
            this.$message.error("è¯„è®ºå‘å¸ƒå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•");
          })
          .finally(() => {
            this.commentInput.submitting = false;
          })
      },

      /**
       * åˆ é™¤è¯„è®º
       */
      deleteComment(comment) {
        if (!comment || !comment.id) {
          this.$message.error("è¯„è®ºä¿¡æ¯å¼‚å¸¸");
          return;
        }

        if (!this.user || this.user.id !== comment.userId) {
          this.$message.error("åªèƒ½åˆ é™¤è‡ªå·±çš„è¯„è®º");
          return;
        }

        this.$confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è¯„è®ºå—ï¼Ÿ', 'æç¤º', {
          confirmButtonText: 'ç¡®å®š',
          cancelButtonText: 'å–æ¶ˆ',
          type: 'warning'
        }).then(() => {
          axios.delete(`/blog-comments/${comment.id}`)
            .then((data) => {
              this.$message.success("è¯„è®ºåˆ é™¤æˆåŠŸ");

              // é‡æ–°åŠ è½½è¯„è®ºåˆ—è¡¨
              this.comments.page = 1; // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
              this.loadComments();

              // å‚è€ƒç‚¹èµåŠŸèƒ½ï¼Œé‡æ–°è·å–åšå®¢æ•°æ®ä»¥ç¡®ä¿è¯„è®ºæ€»æ•°å‡†ç¡®
              if (this.blog && this.blog.id) {
                axios.get("/blog/" + this.blog.id)
                  .then((blogData) => {
                    const updatedBlogData = blogData.data;
                    if (updatedBlogData) {
                      // ä¿æŒå›¾ç‰‡æ•°æ®æ ¼å¼
                      if (updatedBlogData.images) {
                        updatedBlogData.images = updatedBlogData.images.split(",");
                      } else {
                        updatedBlogData.images = [];
                      }
                      // æ›´æ–°åšå®¢æ•°æ®ï¼ŒåŒ…æ‹¬å¯èƒ½çš„è¯„è®ºæ€»æ•°
                      this.blog = Object.assign(this.blog, updatedBlogData);
                    }
                  })
                  .catch(err => {
                    console.error("è·å–æ›´æ–°åçš„åšå®¢ä¿¡æ¯å¤±è´¥:", err);
                  });
              }
            })
            .catch(err => {
              console.error("åˆ é™¤è¯„è®ºå¤±è´¥:", err);
              this.$message.error("åˆ é™¤è¯„è®ºå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•");
            })
        }).catch(() => {
          // ç”¨æˆ·å–æ¶ˆåˆ é™¤
        });
      },

      // ========== åŸæœ‰æ–¹æ³• ==========

      // è·å–çˆ¶å®¹å™¨å®½åº¦ï¼Œå¹¶ä¸”æ›´æ–°æ‰€æœ‰çš„å­èŠ‚ç‚¹å®½åº¦ï¼Œå› ä¸ºæˆ‘ä»¬é»˜è®¤æ‰€æœ‰å­èŠ‚ç‚¹çš„å®½é«˜ç­‰äºçˆ¶èŠ‚ç‚¹çš„å®½é«˜
      updateItemWidth() {
        if (!this.container) return;
        this._width = this.container.offsetWidth || document.documentElement.offsetWidth
      },
      // æ ¹æ®å½“å‰æ´»åŠ¨å­é¡¹çš„ä¸‹æ ‡è®¡ç®—å„ä¸ªå­é¡¹çš„Xè½´ä½ç½®
      // è®¡ç®—å…¬å¼(å­é¡¹çš„ä¸‹æ ‡ - å½“å‰æ´»åŠ¨ä¸‹æ ‡) * å­é¡¹å®½åº¦ + åç§»(æ‰‹æŒ‡ç§»åŠ¨è·ç¦»)ï¼›
      setTransform(offset) {
        if (!this.container || !this.items || this.items.length === 0) return;
        offset = offset || 0
        each(this.items, (item, i) => {
          let distance = (i - this.active) * this._width + offset
          let transform = `translate3d(${distance}px, 0, 0)`
          item.style.webkitTransform = transform
          item.style.transform = transform
        })
      },
      // ç»™æ¯ä¸€ä¸ªå­é¡¹æ·»åŠ transitionè¿‡åº¦åŠ¨ç”»
      setTransition(duration) {
        if (!this.container || !this.items || this.items.length === 0) return;
        duration = duration || this.duration
        duration = typeof duration === 'number' ? (duration + 'ms') : duration
        each(this.items, (item) => {
          item.style.webkitTransition = duration
          item.style.transition = duration
        })
      },
      moveStart(e) {
        if (!this.container) return;
        console.log('moveStart')
        this.start.x = e.changedTouches[0].pageX
        this.start.y = e.changedTouches[0].pageY

        // åªæœ‰éåŠ¨æ€é«˜åº¦æ¨¡å¼æ‰è®¾ç½®transition
        if (!this.container.classList.contains('dynamic-height')) {
          this.setTransition('none')
        }
      },
      moving(e) {
        if (!this.container) return;
        console.log('moving')
        e.preventDefault()
        e.stopPropagation()
        let distanceX = e.changedTouches[0].pageX - this.start.x
        let distanceY = e.changedTouches[0].pageY - this.start.y
        if (Math.abs(distanceX) > Math.abs(distanceY)) {
          this.isMoving = true
          this.move.x = this.start.x + distanceX
          this.move.y = this.start.y + distanceY
          // å½“æ´»åŠ¨å­é¡¹ä¸ºç¬¬ä¸€é¡¹ä¸”æ‰‹æŒ‡å‘å³æ»‘åŠ¨æˆ–è€…æ´»åŠ¨é¡¹ä¸ºæœ€åä¸€é¡¹åˆ‡å‘å·¦æ»‘åŠ¨çš„æ—¶å€™ï¼Œæ·»åŠ é˜»åŠ›ï¼Œå½¢æˆä¸€ä¸ªæ‹‰å¼¹ç°§çš„æ•ˆæœ
          if ((this.active === 0 && distanceX > 0) || (this.active === (this.items.length - 1) && distanceX < 0)) {
            distanceX = distanceX * this.resistance
          }
          this.setTransform(distanceX)
        }
      },
      moveEnd(e) {
        if (!this.container || !this.isMoving) return;
        console.log('moveEnd')
        e.preventDefault()
        e.stopPropagation()
        let distance = this.move.x - this.start.x
        if (Math.abs(distance) > this.sensitivity) {
          if (distance < 0) {
            this.next()
          } else {
            this.prev()
          }
        } else {
          this.back()
        }
        this.reset()
        this.isMoving = false
      },
      next() {
        let index = this.active + 1
        // è¿ç”¨åŠ¨ç”»åˆ‡æ¢åˆ°æŒ‡å®šä¸‹æ ‡çš„å­é¡¹
        this.go(index)
      },
      prev() {
        let index = this.active - 1
        // è¿ç”¨åŠ¨ç”»åˆ‡æ¢åˆ°æŒ‡å®šä¸‹æ ‡çš„å­é¡¹
        this.go(index)
      },
      reset() {
        this.start.x = 0
        this.start.y = 0
        this.move.x = 0
        this.move.y = 0
      },
      back() {
        // åªæœ‰éåŠ¨æ€é«˜åº¦æ¨¡å¼æ‰ä½¿ç”¨transitionå’Œtransform
        if (!this.container || !this.container.classList.contains('dynamic-height')) {
          this.setTransition()
          this.setTransform()
        }
      },
      destroy() {
        this.setTransition('none')
      },
      // è¿ç”¨åŠ¨ç”»åˆ‡æ¢åˆ°æŒ‡å®šä¸‹æ ‡çš„å­é¡¹
      go(index) {
        this.active = index
        if (this.active < 0) {
          this.active = 0
        } else if (this.active > this.items.length - 1) {
          this.active = this.items.length - 1
        }
        this.$emit('change', this.active)

        // æ£€æŸ¥æ˜¯å¦ä¸ºåŠ¨æ€é«˜åº¦æ¨¡å¼
        if (this.container && this.container.classList.contains('dynamic-height')) {
          // åŠ¨æ€é«˜åº¦æ¨¡å¼ï¼šæ˜¾ç¤º/éšè—å›¾ç‰‡
          this.items.forEach((item, i) => {
            if (i === this.active) {
              item.style.display = 'block';
            } else {
              item.style.display = 'none';
            }
          });
        } else {
          // ä¼ ç»Ÿæ¨¡å¼ï¼šä½¿ç”¨transform
          this.setTransition()
          this.setTransform()
        }
      }
    }
  })
  console.log("=== Vueå®ä¾‹åˆ›å»ºå®Œæˆ ===");
} catch (error) {
  console.error("=== Vueå®ä¾‹åˆ›å»ºå¤±è´¥ ===", error);
}
</script>
</body>
</html>
  