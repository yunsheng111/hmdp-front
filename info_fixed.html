<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
  <title>黑马点评 - 个人主页</title>
  <!-- 引入样式 -->
  <link rel="stylesheet" href="./css/element.css">
  <link href="./css/main.css" rel="stylesheet">
  <link href="./css/info.css" rel="stylesheet">

</head>

<body>
<div id="app" v-cloak>
  <div class="header">
    <div class="header-back-btn" @click="goBack"><i class="el-icon-arrow-left"></i></div>
    <div class="header-title">个人主页</div>
    <div style="width: 10%; min-width: 30px;"></div>
  </div>
  <div class="basic">
    <div class="basic-icon">
      <img :src="user.icon || '/imgs/icons/default-icon.png'" alt="用户头像">
    </div>
    <div class="basic-info">
      <div class="name">{{user.nickName}}</div>
      <span v-if="user.city">{{user.city}}</span>
      <span v-else>未知城市</span>
    </div>
    <div class="user-actions">
        <div class="edit-btn" @click="toEdit">
            编辑资料
        </div>
        <div class="logout-btn" @click="logout">
            退出
        </div>
    </div>
  </div>
  <div class="introduce" @click="toEditIntro">
    <span v-if="info.introduce" v-html="info.introduce"></span>
    <span v-else>添加个人简介，让大家更好的认识你 <i class="el-icon-edit"></i></span>
  </div>
  <div class="content">
    <el-tabs v-model="activeName" @tab-click="handleClick">
      <el-tab-pane label="笔记" name="1">
        <div class="blog-list-wrapper">
            <div class="blog-container" ref="blogContainer">
            <!-- 只显示前N条笔记，可以考虑从配置或数据中获取这个N -->
            <div v-for="(b, index) in displayedBlogs" :key="b.id" class="blog-item" @click="toBlogDetail(b)">
                <div class="blog-img"><img :src="b.images.split(',')[0]" :alt="b.title"></div>
                <div class="blog-info">
                <div class="blog-title">{{b.title}}</div>
                <div class="blog-actions">
                    <div class="blog-liked"><img src="/imgs/icons/thumb-up-line.svg" alt="点赞"> {{b.liked}}</div>
                    <div class="blog-comments"><i class="el-icon-chat-dot-round"></i> {{b.comments}}</div>
                </div>
                </div>
            </div>
            <!-- 查看更多笔记按钮 -->
            <div class="more-blogs-btn" @click="loadMoreBlogs" v-if="canLoadMoreBlogs">
                <i class="el-icon-document"></i>
                <span>查看更多笔记 ({{remainingBlogCount}})</span>
            </div>
            <!-- 暂无数据提示 -->
            <div v-if="blogs.length === 0 && !loadingBlogs" class="empty-blog-tip">
                <i class="el-icon-notebook-1"></i>
                这里空空如也，快去发布第一篇笔记吧！
            </div>
            <div v-if="loadingBlogs" class="loading-tip">
                <i class="el-icon-loading"></i> 笔记加载中...
            </div>
            </div>
        </div>
      </el-tab-pane>
      <el-tab-pane label="评价" name="2">评价</el-tab-pane>
      <el-tab-pane label="粉丝(0)" name="3">粉丝(0)</el-tab-pane>
      <el-tab-pane label="关注(0)" name="4">
        <div class="blog-list" @scroll="onScroll">
          <div class="blog-box" v-for="b in blogs2" :key="b.id">
            <div class="blog-img2" @click="toBlogDetail(b)"><img :src="b.img" alt=""></div>
            <div class="blog-title">{{b.title}}</div>
            <div class="blog-foot">
              <div class="blog-user-icon"><img :src="b.icon || '/imgs/icons/default-icon.png'" alt=""></div>
              <div class="blog-user-name">{{b.name}}</div>
              <div class="blog-actions">
                <div class="blog-liked" @click="addLike(b)">
                  <svg t="1646634642977" class="icon" viewBox="0 0 1024 1024" version="1.1"
                       xmlns="http://www.w3.org/2000/svg" p-id="2187" width="14" height="14">
                    <path
                        d="M160 944c0 8.8-7.2 16-16 16h-32c-26.5 0-48-21.5-48-48V528c0-26.5 21.5-48 48-48h32c8.8 0 16 7.2 16 16v448zM96 416c-53 0-96 43-96 96v416c0 53 43 96 96 96h96c17.7 0 32-14.3 32-32V448c0-17.7-14.3-32-32-32H96zM505.6 64c16.2 0 26.4 8.7 31 13.9 4.6 5.2 12.1 16.3 10.3 32.4l-23.5 203.4c-4.9 42.2 8.6 84.6 36.8 116.4 28.3 31.7 68.9 49.9 111.4 49.9h271.2c6.6 0 10.8 3.3 13.2 6.1s5 7.5 4 14l-48 303.4c-6.9 43.6-29.1 83.4-62.7 112C815.8 944.2 773 960 728.9 960h-317c-33.1 0-59.9-26.8-59.9-59.9v-455c0-6.1 1.7-12 5-17.1 69.5-109 106.4-234.2 107-364h41.6z m0-64h-44.9C427.2 0 400 27.2 400 60.7c0 127.1-39.1 251.2-112 355.3v484.1c0 68.4 55.5 123.9 123.9 123.9h317c122.7 0 227.2-89.3 246.3-210.5l47.9-303.4c7.8-49.4-30.4-94.1-80.4-94.1H671.6c-50.9 0-90.5-44.4-84.6-95l23.5-203.4C617.7 55 568.7 0 505.6 0z"
                        p-id="2188" :fill="b.isLike ? '#ff6633' : '#82848a'"></path>
                  </svg>
                  {{b.liked}}
                </div>
              </div>
            </div>
          </div>
          <div class="safe-area-bottom"></div>
        </div>
      </el-tab-pane>
    </el-tabs>
  </div>
  <foot-bar :active-btn="4"></foot-bar>
</div>
<script src="./js/vue.js"></script>
<script src="./js/axios.min.js"></script>
<!-- 引入组件库 -->
<script src="./js/element.js"></script>
<script src="./js/common.js"></script>
<script src="./js/footer.js"></script>
<script>
  new Vue({
    el: '#app',
    data: {
      user: null, // 初始化为null，等待从后端获取
      info: { // 初始化为空对象或包含默认值
        introduce: ''
      },
      activeName: '1',
      blogs: [], 
      blogs2: [], 
      currentBlogPage: 1, 
      blogsPerPage: 4,    
      loadedBlogCount: 0, 
      totalBlogCount: 0,  
      loadingBlogs: false, 
      loadingUser: false, // 新增：用于表示用户信息加载状态
    },
    computed: {
      displayedBlogs() {
        return this.blogs.slice(0, this.loadedBlogCount);
      },
      canLoadMoreBlogs() {
        return this.loadedBlogCount < this.totalBlogCount;
      },
      remainingBlogCount() {
        return this.totalBlogCount - this.loadedBlogCount;
      }
    },
    methods: {
      goBack() {
        window.history.back();
      },
      toEdit() {
        // 确保user.id存在才跳转到编辑页，或编辑页能处理无ID情况
        if (this.user && this.user.id) {
          window.location.href = '/info-edit.html'; // 可以考虑传递用户ID: '/info-edit.html?userId=' + this.user.id
        } else {
          this.$message.warning('用户信息加载中，请稍候');
        }
      },
      logout() {
        axios.post("/user/logout") // 使用默认配置的baseURL
          .then(() => {
            this.$message.success('退出成功');
            sessionStorage.removeItem("token"); // 清理token示例
            window.location.href = "/login.html"; // 跳转到登录页
          })
          .catch(err => {
            console.error("退出登录失败:", err);
            this.$message.error('退出失败，请稍后再试');
          });
      },
      toEditIntro() {
        console.log('编辑个人简介');
        this.toEdit(); 
      },
      handleClick(tab, event) {
        console.log('切换到 Tab:', tab.name);
        if (tab.name === '1') {
          if (!this.blogs.length && this.user && this.user.id && !this.loadingBlogs) {
             this.fetchUserBlogs(true); 
          }
        } else if (tab.name === '4') {
          // this.fetchFollowedBlogs(); // 实际获取关注列表的逻辑
        }
      },
      toBlogDetail(blog) {
        window.location.href = '/blog-detail.html?id=' + blog.id;
      },
      async fetchCurrentUserInfo() {
        if (this.loadingUser) return;
        this.loadingUser = true;
        try {
          // 使用默认配置的baseURL
          const response = await axios.get("/user/me"); 
          // 根据axios拦截器的处理，response已经是data了
          this.user = response;
          // 假设简介也在用户信息中，如果不在，可能需要另一个API调用
          this.info.introduce = this.user.introduce || '添加个人简介，让大家更好的认识你 <i class="el-icon-edit"></i>'; 
          // 用户信息获取成功后，获取该用户的博客列表
          this.fetchUserBlogs(true); 
        } catch (error) {
          console.error('获取用户信息异常:', error);
          this.$message.error('获取用户信息异常，请检查网络或稍后再试');
          // window.location.href = '/login.html'; // 发生严重错误也可能需要跳转
        } finally {
          this.loadingUser = false;
        }
      },
      async fetchUserBlogs(isInitialLoad = false) {
        if (!this.user || !this.user.id) { // 确保用户ID存在
          return; 
        }
        if (this.loadingBlogs) return;
        this.loadingBlogs = true;

        if (isInitialLoad) {
          this.currentBlogPage = 1;
          this.blogs = [];
          this.loadedBlogCount = 0;
          this.totalBlogCount = 0; 
        }

        try {
          // 使用默认配置的baseURL
          const response = await axios.get(`/blog/of/user`, { 
            params: {
              userId: this.user.id,
              current: this.currentBlogPage,
              size: this.blogsPerPage
            }
          });

          // 根据axios拦截器的处理，response已经是data了
          let responseData = response;
          
          if (responseData && responseData.list) {
            const newBlogs = responseData.list;
            if (newBlogs.length > 0) {
              this.blogs = isInitialLoad ? newBlogs : [...this.blogs, ...newBlogs];
              this.loadedBlogCount = this.blogs.length;
              this.currentBlogPage++; 
            }
            this.totalBlogCount = responseData.total || this.blogs.length;
          } else {
            this.$message.error('获取笔记列表失败');
            if (isInitialLoad) this.totalBlogCount = 0;
          }
        } catch (error) {
          console.error('获取用户笔记失败:', error);
          this.$message.error('加载笔记异常，请稍后再试');
          if (isInitialLoad) this.totalBlogCount = 0;
        } finally {
          this.loadingBlogs = false;
        }
      },
      loadMoreBlogs() {
        if (this.canLoadMoreBlogs && !this.loadingBlogs) {
          this.fetchUserBlogs();
        }
      }
    },
    created() {
      this.fetchCurrentUserInfo(); // 页面创建时首先获取用户信息
    }
  })
</script>
</body>

</html> 